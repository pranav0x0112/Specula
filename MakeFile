# ---------- CONFIG -----------

TOP      ?= mkTop                  # Set this when calling make, e.g. TOP=mkSpecula
SRC_DIR  ?= src                    # BSV source directory
OUT_DIR  ?= build                  # Where all build outputs go
EXE      ?= sim                    # Simulation executable name

BSC_FLAGS := -sim                  # Enable Bluesim simulation

# ---------- TARGETS -----------

.PHONY: all run clean

all: $(OUT_DIR)/$(EXE)

$(OUT_DIR)/$(EXE): $(SRC_DIR)/*.bsv | $(OUT_DIR)
	@echo "[1/3] Compiling $(TOP)"
	bsc $(BSC_FLAGS) -u -g $(TOP) $(SRC_DIR)/*.bsv -bdir $(OUT_DIR) -info-dir $(OUT_DIR)
	@echo "[2/3] Elaborating"
	bsc $(BSC_FLAGS) -e $(TOP) -o $(OUT_DIR)/$(EXE) -bdir $(OUT_DIR) -info-dir $(OUT_DIR)

run: all
	@echo "[3/3] Running simulation"
	./$(OUT_DIR)/$(EXE)

$(OUT_DIR):
	mkdir -p $(OUT_DIR)

clean:
	rm -rf $(OUT_DIR)
